
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>3D Wireframe Walker (559 P3)</title>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="class.js"></script>
    <script src="entity.js"></script>
    <script src="vector.js"></script>
    <script src="animation.js"></script>
    <script src="matrix.js"></script>
    <script src="bone.js"></script>
    <script src="inputHandler.js"></script>
  
</head>
<body>
    <div id="containerDiv" align="center">
        <center>Click into the canvas and use WASD to move</center>
        <canvas id="canvas"></canvas>
    </div>
  



<script type='text/javascript'>//<![CDATA[

var canvas = document.getElementById("canvas");
canvas.width = 800;
canvas.height = 400;
var ctx = canvas.getContext('2d');

BoxBone = Bone.extend({
    init: function(name, color, min, max) {
        Bone.init.apply(this, [name]);
        this.color = color;
        this.points = [
                        new Vector(min.x, min.y, min.z),
                        new Vector(max.x, min.y, min.z),
                        new Vector(min.x, min.y, max.z),
                        new Vector(max.x, min.y, max.z),

                        new Vector(min.x, max.y, min.z),
                        new Vector(max.x, max.y, min.z),
                        new Vector(min.x, max.y, max.z),
                        new Vector(max.x, max.y, max.z),
                      ];
        this.pairs = [[0,4],[1,5],[2,6],[3,7], //Edges
                      [0,1],[1,3],[3,2],[2,0], //Top
                      [4,5],[5,7],[7,6],[6,4]]; //Botom
        this.min = min;
        this.max = max;
        this.draw = function(ctx, transform) {
            var transform = transform.mul(this.withParentTransform());
            var transformedPoints = this.points.map(function(p) { return transform.transform(p); });
            var color = this.color;
            this.pairs.forEach(function(pair) {
                var p1 = transformedPoints[pair[0]];
                var p2 = transformedPoints[pair[1]];
                if(p1.w <= 0 || p2.w <= 0) return;
                p1 = p1.mul(1 / p1.w);
                p2 = p2.mul(1 / p2.w);
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.moveTo(p1.x * canvas.width, p1.y * canvas.height);
                ctx.lineTo(p2.x * canvas.width, p2.y * canvas.height);
                ctx.stroke();
            })
        }
    }
});
var dude = new Entity();
var skeleton = new Skeleton();
dude.addComponent(skeleton);
chest = new BoxBone("chest", "red", new Vector(-20,-20,-15), new Vector(20,20,15));
skeleton.addBone(chest, null);
head = new BoxBone("head", "orange", new Vector(-10,-10,-10), new Vector(10,10,10));
skeleton.addBone(head, "chest");
leftThigh = new BoxBone("leftThigh", "blue", new Vector(-20,-25,-10), new Vector(0,0,10));
skeleton.addBone(leftThigh, "chest");
leftCalf = new BoxBone("leftCalf", "green", new Vector(-20,-30, -10), new Vector(0,0,10));
skeleton.addBone(leftCalf, "leftThigh");
rightThigh = new BoxBone("rightThigh", "blue", new Vector(0,-25,-10), new Vector(20,0,10));
skeleton.addBone(rightThigh, "chest");
rightCalf = new BoxBone("rightCalf", "green", new Vector(0,-30, -10), new Vector(20,0,10));
skeleton.addBone(rightCalf, "rightThigh");
rightBicep = new BoxBone("rightBicep", "blue", new Vector(-5, -20, -5), new Vector(5, 0, 5));
skeleton.addBone(rightBicep, "chest");
rightForearm = new BoxBone("rightForearm", "green", new Vector(-5, -20, -5), new Vector(5, 0, 5));
skeleton.addBone(rightForearm, "rightBicep");
leftBicep = new BoxBone("leftBicep", "blue", new Vector(-5, -20, -5), new Vector(5, 0, 5));
skeleton.addBone(leftBicep, "chest");
leftForearm = new BoxBone("leftForearm", "green", new Vector(-5, -20, -5), new Vector(5, 0, 5));
skeleton.addBone(leftForearm, "leftBicep");

anim = new Animation();
dude.addComponent(anim);
anim.addKeyFrame(0, "chest", new Vector(0,0,0));
anim.addKeyFrame(0, "head", new Vector(0, 30,0));
function insertLegFrames(t) {
    anim.addKeyFrame(t + 0, "leftThigh", new Vector(0, -20, 0), new Vector(-Math.PI/4,0));
    anim.addKeyFrame(t + 0, "rightThigh", new Vector(0, -20, 0), new Vector(Math.PI/4,0,0));
    anim.addKeyFrame(t + 0, "leftCalf", new Vector(0, -20, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 0, "rightCalf", new Vector(0, -20, 0), new Vector(Math.PI/8,0,0));

    anim.addKeyFrame(t + 1, "leftThigh", new Vector(0, -20, 0), new Vector(-Math.PI/8,0,0));
    anim.addKeyFrame(t + 1, "rightThigh", new Vector(0, -20, 0), new Vector(Math.PI/8,0,0));

    anim.addKeyFrame(t + 2, "leftThigh", new Vector(0, -20, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 2, "leftCalf", new Vector(0, -20, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 2, "rightThigh", new Vector(0, -20, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 2, "rightCalf", new Vector(0, -20, 0), new Vector(Math.PI/2,0,0));

    anim.addKeyFrame(t + 3, "leftThigh", new Vector(0, -20, 0), new Vector(Math.PI/8,0,0));
    anim.addKeyFrame(t + 3, "rightThigh", new Vector(0, -20, 0), new Vector(-Math.PI/8,0,0));
    anim.addKeyFrame(t + 3, "rightCalf", new Vector(0, -20, 0), new Vector(Math.PI/4,0,0));

    anim.addKeyFrame(t + 4, "leftThigh", new Vector(0, -20, 0), new Vector(Math.PI/4,0,0));
    anim.addKeyFrame(t + 4, "leftCalf", new Vector(0, -20, 0), new Vector(Math.PI/8,0,0));
    anim.addKeyFrame(t + 4, "rightThigh", new Vector(0, -20, 0), new Vector(-Math.PI/4,0,0));
    anim.addKeyFrame(t + 4, "rightCalf", new Vector(0, -20, 0), new Vector(0,0,0));

    anim.addKeyFrame(t + 5, "rightThigh", new Vector(0, -20, 0), new Vector(-Math.PI/8,0,0));
    anim.addKeyFrame(t + 5, "leftThigh", new Vector(0, -20, 0), new Vector(Math.PI/8,0,0));

    anim.addKeyFrame(t + 6, "rightThigh", new Vector(0, -20, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 6, "rightCalf", new Vector(0, -20, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 6, "leftThigh", new Vector(0, -20, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 6, "leftCalf", new Vector(0, -20, 0), new Vector(Math.PI/2,0,0));

    anim.addKeyFrame(t + 7, "rightThigh", new Vector(0, -20, 0), new Vector(Math.PI/8,0,0));
    anim.addKeyFrame(t + 7, "leftThigh", new Vector(0, -20, 0), new Vector(-Math.PI/8,0,0));
    anim.addKeyFrame(t + 7, "leftCalf", new Vector(0, -20, 0), new Vector(Math.PI/4,0,0));

    anim.addKeyFrame(t + 8, "rightThigh", new Vector(0, -20, 0), new Vector(Math.PI/4,0,0));
    anim.addKeyFrame(t + 8, "rightCalf", new Vector(0, -20, 0), new Vector(Math.PI/8,0,0));
    anim.addKeyFrame(t + 8, "leftThigh", new Vector(0, -20, 0), new Vector(-Math.PI/4,0,0));
    anim.addKeyFrame(t + 8, "leftCalf", new Vector(0, -20, 0), new Vector(0,0,0));
}

function insertArmFrames(t) {
    anim.addKeyFrame(t + 0, "rightBicep", new Vector(25, 20, 0), new Vector(-Math.PI/4));
    anim.addKeyFrame(t + 0, "rightForearm", new Vector(0, -20, 0), new Vector(-Math.PI/2));
    anim.addKeyFrame(t + 2.5, "rightForearm", new Vector(0, -20, 0), new Vector());
    anim.addKeyFrame(t + 4, "rightBicep", new Vector(25, 20, 0), new Vector(Math.PI/2));
    anim.addKeyFrame(t + 8, "rightBicep", new Vector(25, 20, 0), new Vector(-Math.PI/4));
    anim.addKeyFrame(t + 8, "rightForearm", new Vector(0, -20, 0), new Vector(-Math.PI/2));

    anim.addKeyFrame(t + 0, "leftBicep", new Vector(-25, 20, 0), new Vector(Math.PI/4));
    anim.addKeyFrame(t + 0, "leftForearm", new Vector(0, -20, 0), new Vector());
    anim.addKeyFrame(t + 2.5, "leftForearm", new Vector(0, -20, 0), new Vector(-Math.PI/2));
    anim.addKeyFrame(t + 4, "leftBicep", new Vector(-25, 20, 0), new Vector(-Math.PI/2));
    anim.addKeyFrame(t + 8, "leftBicep", new Vector(-25, 20, 0), new Vector(Math.PI/4));
    anim.addKeyFrame(t + 8, "leftForearm", new Vector(0, -20, 0), new Vector());
}
insertArmFrames(0);
insertLegFrames(0);
insertArmFrames(8);
insertLegFrames(8);
insertArmFrames(16);
insertLegFrames(16);
insertArmFrames(24);
insertLegFrames(24);
//anim.addKeyFrame(32, "chest", MatrixCreateTranslation(0,0,400));
var mouseDiff = {x: 0, y: 0};
function moveCallback(x, y) {
    mouseDiff.x += x;
    mouseDiff.y += y;
}
initMouseHandling($("#canvas"), moveCallback);
ctx.clearRect(0, 0, canvas.width, canvas.height);

var prev_timestamp = 0;
var projection = MatrixCreateProjection(Math.PI/2, 2, 1, 20);
var cameraPosition = new Vector(100, 0, 100);
var theta = -3 * Math.PI/4;
var phi = 0;
var moveSpeed = 5;
var moveDir = new Vector();
var mouseSensitivity = 1 / 100;
ctx.setTransform(1, 0, 0, -1, canvas.width / 2, canvas.height / 2);
function loop(timestamp) {
    var delta = 0;
    if (prev_timestamp > 0) delta = timestamp - prev_timestamp;
    ctx.clearRect(-canvas.width / 2, -canvas.height/2, canvas.width, canvas.height);

    moveDir = new Vector();
    if(keyboardState[87]) moveDir.z += 1;
    if(keyboardState[83]) moveDir.z -= 1;
    if(keyboardState[68]) moveDir.x += 1;
    if(keyboardState[65]) moveDir.x -= 1;
    moveDir = Matrix.CreateRotationYPR(theta, 0, 0).transform(moveDir);
    cameraPosition = cameraPosition.add(moveDir.mul(moveSpeed));

    theta += mouseDiff.x * mouseSensitivity;
    phi += mouseDiff.y * mouseSensitivity;
    if(theta > Math.PI * 2) theta -= Math.PI * 2;
    dude.update(delta / 1000);
    var view = MatrixCreateView(theta, phi, cameraPosition);
    //var view = MatrixCreateView(Math.PI / 2,0, new Vector(-400,0,200));
    var transform = projection.mul(view);
    for(var key in skeleton.bones) {
        var bone = skeleton.bones[key];
        bone.draw(ctx, transform);        
    }
    prev_timestamp = timestamp;
    mouseDiff = {x: 0, y: 0};
    window.requestAnimationFrame(loop);
}
loop(0);
//]]> 

</script>

</html>


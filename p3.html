
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>3D Wireframe Walker (559 P3)</title>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="vector.js"></script>
    <script src="animation.js"></script>
    <script src="matrix.js"></script>
    <script src="bone.js"></script>
    <script src="inputHandler.js"></script>
  
</head>
<body>
    <div id="containerDiv" align="center">
        <center>Click into the canvas and use WASD to move</center>
        <canvas id="canvas"></canvas>
    </div>
  



<script type='text/javascript'>//<![CDATA[

var canvas = document.getElementById("canvas");
canvas.width = 800;
canvas.height = 400;
var ctx = canvas.getContext('2d');

BoxBone = function(name, parent, color, min, max) {
    Bone.apply(this, [name, parent]);
    this.color = color;
    this.points = [
                    new Vector(min.x, min.y, min.z),
                    new Vector(max.x, min.y, min.z),
                    new Vector(min.x, min.y, max.z),
                    new Vector(max.x, min.y, max.z),

                    new Vector(min.x, max.y, min.z),
                    new Vector(max.x, max.y, min.z),
                    new Vector(min.x, max.y, max.z),
                    new Vector(max.x, max.y, max.z),
                  ];
    this.pairs = [[0,4],[1,5],[2,6],[3,7], //Edges
                  [0,1],[1,3],[3,2],[2,0], //Top
                  [4,5],[5,7],[7,6],[6,4]]; //Botom
    this.min = min;
    this.max = max;
    this.draw = function(ctx, transform) {
        var transform = transform.mul(this.withParentTransform());
        var transformedPoints = this.points.map(function(p) { return transform.transform(p); });
        var color = this.color;
        this.pairs.forEach(function(pair) {
            var p1 = transformedPoints[pair[0]];
            var p2 = transformedPoints[pair[1]];
            if(p1.w <= 0 || p2.w <= 0) return;
            p1 = p1.mul(1 / p1.w);
            p2 = p2.mul(1 / p2.w);
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.moveTo(p1.x * canvas.width, p1.y * canvas.height);
            ctx.lineTo(p2.x * canvas.width, p2.y * canvas.height);
            ctx.stroke();
        })
    }
}

chest = new BoxBone("chest", null, "red", new Vector(-20,-20,-15), new Vector(20,20,15));
head = new BoxBone("head", chest, "orange", new Vector(-10,-10,-10), new Vector(10,10,10));
leftThigh = new BoxBone("leftThigh", chest, "blue", new Vector(-20,-25,-10), new Vector(0,0,10));
leftCalf = new BoxBone("leftCalf", leftThigh, "blue", new Vector(-20,-30, -10), new Vector(0,0,10));
rightThigh = new BoxBone("rightThigh", chest, "blue", new Vector(0,-25,-10), new Vector(20,0,10));
rightCalf = new BoxBone("rightCalf", rightThigh, "blue", new Vector(0,-30, -10), new Vector(20,0,10));

anim = new Animation(chest);
anim.addKeyFrame(0, "chest", MatrixCreateTranslation(0,0,0));
anim.addKeyFrame(0, "head", MatrixCreateTranslation(0, 30,0));
function insertLegFrames(t) {
    anim.addKeyFrame(t + 0, "leftThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/4,0)));
    anim.addKeyFrame(t + 0, "rightThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/4,0)));
    anim.addKeyFrame(t + 0, "leftCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 0, "rightCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/8,0)));

    anim.addKeyFrame(t + 1, "leftThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/8,0)));
    anim.addKeyFrame(t + 1, "rightThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/8,0)));

    anim.addKeyFrame(t + 2, "leftThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 2, "leftCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 2, "rightThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 2, "rightCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/2,0)));

    anim.addKeyFrame(t + 3, "leftThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/8,0)));
    anim.addKeyFrame(t + 3, "rightThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/8,0)));
    anim.addKeyFrame(t + 3, "rightCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/4,0)));

    anim.addKeyFrame(t + 4, "leftThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/4,0)));
    anim.addKeyFrame(t + 4, "leftCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0, Math.PI/8,0)));
    anim.addKeyFrame(t + 4, "rightThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/4,0)));
    anim.addKeyFrame(t + 4, "rightCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,0,0)));

    anim.addKeyFrame(t + 5, "rightThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/8,0)));
    anim.addKeyFrame(t + 5, "leftThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/8,0)));

    anim.addKeyFrame(t + 6, "rightThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 6, "rightCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 6, "leftThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 6, "leftCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/2,0)));

    anim.addKeyFrame(t + 7, "rightThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/8,0)));
    anim.addKeyFrame(t + 7, "leftThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/8,0)));
    anim.addKeyFrame(t + 7, "leftCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/4,0)));

    anim.addKeyFrame(t + 8, "rightThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,Math.PI/4,0)));
    anim.addKeyFrame(t + 8, "rightCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0, Math.PI/8,0)));
    anim.addKeyFrame(t + 8, "leftThigh", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/4,0)));
    anim.addKeyFrame(t + 8, "leftCalf", MatrixCreateTranslation(0, -20, 0).mul(MatrixCreateRotationYPR(0,0,0)));
}
insertLegFrames(0);
insertLegFrames(8);
insertLegFrames(16);
insertLegFrames(24);
//anim.addKeyFrame(32, "chest", MatrixCreateTranslation(0,0,400));
var mouseDiff = {x: 0, y: 0};
function moveCallback(x, y) {
    mouseDiff.x += x;
    mouseDiff.y += y;
}
initMouseHandling($("#canvas"), moveCallback);
ctx.clearRect(0, 0, canvas.width, canvas.height);

var prev_timestamp = 0;
var projection = MatrixCreateProjection(Math.PI/2, 2, 1, 20);
var cameraPosition = new Vector(0, 0, -200);
var theta = 0;
var phi = 0;
var moveSpeed = 5;
var moveDir = new Vector();
var mouseSensitivity = 1 / 100;
ctx.setTransform(1, 0, 0, -1, canvas.width / 2, canvas.height / 2);
function loop(timestamp) {
    var delta = 0;
    if (prev_timestamp > 0) delta = timestamp - prev_timestamp;
    ctx.clearRect(-canvas.width / 2, -canvas.height/2, canvas.width, canvas.height);

    moveDir = new Vector();
    if(keyboardState[87]) moveDir.z += 1;
    if(keyboardState[83]) moveDir.z -= 1;
    if(keyboardState[68]) moveDir.x += 1;
    if(keyboardState[65]) moveDir.x -= 1;
    moveDir = MatrixCreateRotationYPR(theta, 0, 0).transform(moveDir);
    cameraPosition = cameraPosition.add(moveDir.mul(moveSpeed));

    theta += mouseDiff.x * mouseSensitivity;
    phi += mouseDiff.y * mouseSensitivity;
    if(theta > Math.PI * 2) theta -= Math.PI * 2;
    anim.update(delta / 150);
    var view = MatrixCreateView(theta, phi, cameraPosition);
    //var view = MatrixCreateView(Math.PI / 2,0, new Vector(-400,0,200));
    var transform = projection.mul(view);
    for(var key in chest.bones) {
        var bone = chest.bones[key];
        bone.draw(ctx, transform);        
    }
    prev_timestamp = timestamp;
    mouseDiff = {x: 0, y: 0};
    window.requestAnimationFrame(loop);
}
loop(0);
//]]> 

</script>

</html>


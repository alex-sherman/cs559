
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>3D Solid Walker</title>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="class.js"></script>
    <script src="entity.js"></script>
    <script src="vector.js"></script>
    <script src="animation.js"></script>
    <script src="matrix.js"></script>
    <script src="bone.js"></script>
    <script src="inputHandler.js"></script>
    <script src="primitive.js"></script>
    <script src="mesh.js"></script>
    <script src="renderManager.js"></script>
  
</head>
<body>
    <div id="containerDiv" align="center">
        <center>
            Click into the canvas and use WASD to move the camera around<br>
            Check out the weighted blending of the animation bones, neat.<br>
        </center>
        <canvas id="canvas"></canvas>
    </div>
  



<script type='text/javascript'>//<![CDATA[

var canvas = document.getElementById("canvas");
canvas.width = 800;
canvas.height = 400;
var ctx = canvas.getContext('2d');
var renderManager = new RenderManager(ctx, canvas.width, canvas.height);

var dude = new Entity();
var skeleton = new Skeleton();
dude.addComponent(skeleton);
chest = new Bone("chest");
skeleton.addBone(chest, null);
head = new Bone("head", MatrixCreateTranslation(0, -3, 0));
skeleton.addBone(head, "chest");
leftThigh = new Bone("leftThigh", MatrixCreateTranslation(1, 2, 0));
skeleton.addBone(leftThigh, "chest");
leftCalf = new Bone("leftCalf", MatrixCreateTranslation(1, 4, 0));
skeleton.addBone(leftCalf, "leftThigh");
rightThigh = new Bone("rightThigh", MatrixCreateTranslation(-1, 2, 0));
skeleton.addBone(rightThigh, "chest");
rightCalf = new Bone("rightCalf", MatrixCreateTranslation(-1, 4, 0));
skeleton.addBone(rightCalf, "rightThigh");
rightBicep = new Bone("rightBicep", MatrixCreateTranslation(-2.5, -2, 0));
skeleton.addBone(rightBicep, "chest");
rightForearm = new Bone("rightForearm", MatrixCreateTranslation(-2.5, 0, 0));
skeleton.addBone(rightForearm, "rightBicep");
leftBicep = new Bone("leftBicep", MatrixCreateTranslation(2.5, -2, 0));
skeleton.addBone(leftBicep, "chest");
leftForearm = new Bone("leftForearm", MatrixCreateTranslation(2.5, 0, 0));
skeleton.addBone(leftForearm, "leftBicep");

anim = new Animation();
dude.addComponent(anim);

var mesh = new Mesh();
dude.addComponent(mesh);
var meshPart = Primitive.Cube(new Vector(-2, -2, -1.5), new Vector(2, 2, 1.5));
meshPart.bones = ["chest", "leftThigh", "rightThigh"];
meshPart.vertices[0].weights = [0.8, 0.2, 0];
meshPart.vertices[1].weights = [0.8, 0.2, 0];
meshPart.vertices[2].weights = [0.8, 0, 0.2];
meshPart.vertices[3].weights = [0.8, 0, 0.2];

meshPart.color = "red";
mesh.parts.push(meshPart);

["leftThigh", "leftCalf", "rightThigh", "rightCalf", ].map(function(bone, i, bones) {
    var offset = new Vector(0, -3, 0);
    if(i < 2) offset.x -= 1;
    else offset.x += 1;
    if(i % 2) offset.y -= 2;
    meshPart = Primitive.Cube(new Vector(-1,-1,-1).add(offset), new Vector(1,1,1).add(offset));
    meshPart.bones = i % 2 ? [bone, bones[i - 1], bone] : [bone, "chest", bones[i + 1]];
    meshPart.color = i % 2 ? "green" : "blue";
    //if(i % 2) {
        meshPart.vertices.map(function(vertex, j, vertices) {
            if(j > 3)
                vertex.weights = [0.2, 0.8, 0];
            else
                vertex.weights = [0.8, 0, 0.2];
        })
    //}
    mesh.parts.push(meshPart);
});

["leftBicep", "leftForearm", "rightBicep", "rightForearm"].map(function(bone, i, bones) {
    var offset = new Vector(0, 2, 0);
    if(i < 2) offset.x -= 2.5;
    else offset.x += 2.5;
    if(i % 2) offset.y -= 2;
    meshPart = Primitive.Cube(new Vector(-0.5,-2,-0.5).add(offset), new Vector(0.5,0,0.5).add(offset));
    meshPart.bones = i % 2 ? [bone, bones[i - 1], bone] : [bone, "chest", bones[i + 1]];
    meshPart.color = i % 2 ? "green" : "blue";
    //if(i % 2) {
        meshPart.vertices.map(function(vertex, j, vertices) {
            if(j > 3)
                vertex.weights = [0.6, 0.4, 0];
            else
                vertex.weights = [0.4, 0, 0.6];
        })
    //}
    mesh.parts.push(meshPart);
});

meshPart = Primitive.Cube(new Vector(-1,2,-1), new Vector(1,4,1));
meshPart.bones = ["head"];
meshPart.color = "orange"
mesh.parts.push(meshPart);

anim.addKeyFrame(0, "chest", new Vector(0, 0, 0));
anim.addKeyFrame(0, "head", new Vector(0, 3,0));
function insertLegFrames(t) {
    anim.addKeyFrame(t + 0, "leftThigh", new Vector(-1, -2, 0), new Vector(-Math.PI/4,0));
    anim.addKeyFrame(t + 0, "rightThigh", new Vector(1, -2, 0), new Vector(Math.PI/4,0,0));
    anim.addKeyFrame(t + 0, "leftCalf", new Vector(0, -2, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 0, "rightCalf", new Vector(0, -2, 0), new Vector(Math.PI/8,0,0));

    anim.addKeyFrame(t + 1, "leftThigh", new Vector(-1, -2, 0), new Vector(-Math.PI/8,0,0));
    anim.addKeyFrame(t + 1, "rightThigh", new Vector(1, -2, 0), new Vector(Math.PI/8,0,0));

    anim.addKeyFrame(t + 2, "leftThigh", new Vector(-1, -2, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 2, "leftCalf", new Vector(0, -2, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 2, "rightThigh", new Vector(1, -2, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 2, "rightCalf", new Vector(0, -2, 0), new Vector(Math.PI/2,0,0));

    anim.addKeyFrame(t + 3, "leftThigh", new Vector(-1, -2, 0), new Vector(Math.PI/8,0,0));
    anim.addKeyFrame(t + 3, "rightThigh", new Vector(1, -2, 0), new Vector(-Math.PI/8,0,0));
    anim.addKeyFrame(t + 3, "rightCalf", new Vector(0, -2, 0), new Vector(Math.PI/4,0,0));

    anim.addKeyFrame(t + 4, "leftThigh", new Vector(-1, -2, 0), new Vector(Math.PI/4,0,0));
    anim.addKeyFrame(t + 4, "leftCalf", new Vector(0, -2, 0), new Vector(Math.PI/8,0,0));
    anim.addKeyFrame(t + 4, "rightThigh", new Vector(1, -2, 0), new Vector(-Math.PI/4,0,0));
    anim.addKeyFrame(t + 4, "rightCalf", new Vector(0, -2, 0), new Vector(0,0,0));

    anim.addKeyFrame(t + 5, "rightThigh", new Vector(1, -2, 0), new Vector(-Math.PI/8,0,0));
    anim.addKeyFrame(t + 5, "leftThigh", new Vector(-1, -2, 0), new Vector(Math.PI/8,0,0));

    anim.addKeyFrame(t + 6, "rightThigh", new Vector(1, -2, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 6, "rightCalf", new Vector(0, -2, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 6, "leftThigh", new Vector(-1, -2, 0), new Vector(0,0,0));
    anim.addKeyFrame(t + 6, "leftCalf", new Vector(0, -2, 0), new Vector(Math.PI/2,0,0));

    anim.addKeyFrame(t + 7, "rightThigh", new Vector(1, -2, 0), new Vector(Math.PI/8,0,0));
    anim.addKeyFrame(t + 7, "leftThigh", new Vector(-1, -2, 0), new Vector(-Math.PI/8,0,0));
    anim.addKeyFrame(t + 7, "leftCalf", new Vector(0, -2, 0), new Vector(Math.PI/4,0,0));

    anim.addKeyFrame(t + 8, "rightThigh", new Vector(1, -2, 0), new Vector(Math.PI/4,0,0));
    anim.addKeyFrame(t + 8, "rightCalf", new Vector(0, -2, 0), new Vector(Math.PI/8,0,0));
    anim.addKeyFrame(t + 8, "leftThigh", new Vector(-1, -2, 0), new Vector(-Math.PI/4,0,0));
    anim.addKeyFrame(t + 8, "leftCalf", new Vector(0, -2, 0), new Vector(0,0,0));
}

function insertArmFrames(t) {
    anim.addKeyFrame(t + 0, "rightBicep", new Vector(2.5, 2, 0), new Vector(-Math.PI/4));
    anim.addKeyFrame(t + 0, "rightForearm", new Vector(0, -2, 0), new Vector(-Math.PI/2));
    anim.addKeyFrame(t + 2.5, "rightForearm", new Vector(0, -2, 0), new Vector());
    anim.addKeyFrame(t + 4, "rightBicep", new Vector(2.5, 2, 0), new Vector(Math.PI/2));
    anim.addKeyFrame(t + 8, "rightBicep", new Vector(2.5, 2, 0), new Vector(-Math.PI/4));
    anim.addKeyFrame(t + 8, "rightForearm", new Vector(0, -2, 0), new Vector(-Math.PI/2));

    anim.addKeyFrame(t + 0, "leftBicep", new Vector(-2.5, 2, 0), new Vector(Math.PI/4));
    anim.addKeyFrame(t + 0, "leftForearm", new Vector(0, -2, 0), new Vector());
    anim.addKeyFrame(t + 2.5, "leftForearm", new Vector(0, -2, 0), new Vector(-Math.PI/2));
    anim.addKeyFrame(t + 4, "leftBicep", new Vector(-2.5, 2, 0), new Vector(-Math.PI/2));
    anim.addKeyFrame(t + 8, "leftBicep", new Vector(-2.5, 2, 0), new Vector(Math.PI/4));
    anim.addKeyFrame(t + 8, "leftForearm", new Vector(0, -2, 0), new Vector());
}
insertArmFrames(0);
insertLegFrames(0);
insertArmFrames(8);
insertLegFrames(8);
insertArmFrames(16);
insertLegFrames(16);
insertArmFrames(24);
insertLegFrames(24);
for (var i = 0; i < anim.keyFrames.length; i++) {
    anim.keyFrames[i].time /= 8;
};
anim.length /= 8;

var mouseDiff = {x: 0, y: 0};
function moveCallback(x, y) {
    mouseDiff.x += x;
    mouseDiff.y += y;
}
initMouseHandling($("#canvas"), moveCallback);
ctx.clearRect(0, 0, canvas.width, canvas.height);

var prev_timestamp = 0;
var projection = MatrixCreateProjection(Math.PI/2, 2, 1, 20);
var cameraPosition = new Vector(10, 0, 10);
var theta = -3 * Math.PI/4;
var phi = 0;
var moveSpeed = 0.1;
var moveDir = new Vector();
var mouseSensitivity = 1 / 100;
ctx.setTransform(1, 0, 0, -1, canvas.width / 2, canvas.height / 2);
function loop(timestamp) {
    var delta = 0;
    if (prev_timestamp > 0) delta = (timestamp - prev_timestamp) / 1000;
    ctx.clearRect(-canvas.width / 2, -canvas.height/2, canvas.width, canvas.height);

    moveDir = new Vector();
    if(keyboardState[87]) moveDir.z += 1;
    if(keyboardState[83]) moveDir.z -= 1;
    if(keyboardState[68]) moveDir.x += 1;
    if(keyboardState[65]) moveDir.x -= 1;
    if(keyboardState[32]) moveDir.y += 1;
    if(keyboardState[17]) moveDir.y -= 1;
    moveDir = Matrix.CreateRotationYPR(theta, 0, 0).transform(moveDir);
    cameraPosition = cameraPosition.add(moveDir.mul(moveSpeed));

    theta += mouseDiff.x * mouseSensitivity;
    phi += mouseDiff.y * mouseSensitivity;
    if(theta > Math.PI * 2) theta -= Math.PI * 2;
    var view = MatrixCreateView(theta, phi, cameraPosition);
    //var view = MatrixCreateView(Math.PI / 2,0, new Vector(-400,0,200));
    var viewProjection = projection.mul(view);
    dude.update(delta);
    dude.draw(renderManager);
    renderManager.draw(viewProjection);
    prev_timestamp = timestamp;
    mouseDiff = {x: 0, y: 0};
    window.requestAnimationFrame(loop);
}
loop(0);
//]]> 

</script>

</html>


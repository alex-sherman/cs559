
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Herp Derp</title>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.3.1/gl-matrix-min.js"></script>
    <script src="class.js"></script>
    <script src="g3dj.js"></script>
    <script src="entity.js"></script>
    <script src="animation.js"></script>
    <script src="bone.js"></script>
    <script src="inputHandler.js"></script>
    <script src="pose.js"></script>
    <script src="mesh.js"></script>
    <script src="renderManager.js"></script>
    <script src="Models/male.g3dj"></script>
    <script src="Models/helicopter.g3dj"></script>
    <script src="Models/anim.g3dj"></script>
    <script src="Shaders/skinned.shader"></script>
    <script src="Shaders/diffuse.shader"></script>
  
</head>
<body>
    <canvas id="canvas" style="position:absolute;"></canvas>
    <div id="containerDiv" align="center">
        <div id ="fps"></div>
        <center>
            Use WASD to move the camera's location, and click into the <br>
            canvas or use the arrow keys to change the camera orientation.<br>
            Space and control move up and down.
        </center>
    </div>
  



<script type='text/javascript'>//<![CDATA[
var canvas = document.getElementById("canvas");
var gl = canvas.getContext("experimental-webgl");

gl.clearColor(0.0, 0.0, 0.0, 1.0);  // Clear to black, fully opaque
gl.clearDepth(1.0);                 // Clear everything
gl.enable(gl.DEPTH_TEST);           // Enable depth testing
gl.depthFunc(gl.LEQUAL);            // Near things obscure far things

function createShader(name, type, source, program) {
    glShader = gl.createShader(type);
    gl.shaderSource(glShader, source);
    gl.compileShader(glShader);
    var compiled = gl.getShaderParameter(glShader, gl.COMPILE_STATUS);
    if(!compiled){
        gl.getError();
        console.error("Shader " + name + " compile error: " + gl.getShaderInfoLog(glShader));
    }
    shader.vertex = glShader;
    gl.attachShader(shader.program, glShader);
}
for(var shaderName in Shaders) {
    var shader = Shaders[shaderName];
    shader.program = gl.createProgram();
    createShader(shaderName + " vertex", gl.VERTEX_SHADER, shader.vertex, shader.program);
    createShader(shaderName + " fragment", gl.FRAGMENT_SHADER, shader.fragment, shader.program);
    gl.linkProgram(shader.program);
}

var projection = mat4.create();
var renderManager = new RenderManager(canvas, canvas.width, canvas.height);
function resizeCallback() {
    canvas.width = document.documentElement.clientWidth - 10;
    canvas.height = document.documentElement.clientHeight - 10;
    renderManager.width = canvas.width;
    renderManager.height = canvas.height;
    projection = mat4.perspective(projection, Math.PI/2, canvas.width / canvas.height, 0.1, 100);
    gl.viewport(0, 0, canvas.width, canvas.height);
}
resizeCallback();
$(window).resize(function() {
    resizeCallback();
})
var mouseDiff = {x: 0, y: 0};
function moveCallback(x, y) {
    mouseDiff.x += x;
    mouseDiff.y += y;
}
initMouseHandling($("#canvas"), moveCallback);

var prev_timestamp = 0;
var cameraPosition = vec3.fromValues(1, 1, 1);
var theta = Math.PI / 4;
var phi = 0;
var moveSpeed = 1;
var cameraSensitivity = 1;
var moveDir = vec3.create();
var mouseSensitivity = 1 / 300;
var dude = new Entity();

var mesh = G3DJToMesh(Models.male);
dude.addComponent(mesh);
dude.Mesh.shader = Shaders.skinned.program;

dudeImage = new Image();
dudeImage.crossOrigin = "anonymous";
dudeImage.onload = function() { mesh.textures["diffuse"] = renderManager.createTexture(dudeImage); }
dudeImage.src = "http://static.vector57.net/cs559/P6/Models/Dude Suit.png";

var skeleton = G3DJToSkeleton(Models.male);
dude.addComponent(skeleton);
var animation = G3DJToAnimation(Models.anim);
dude.addComponent(animation);
dude.addComponent(new Pose());
quat.rotateX(dude.Pose.rotation, dude.Pose.rotation, -Math.PI / 2);

var helicopter = new Entity();
helicopter.addComponent(new Pose());
quat.rotateX(helicopter.Pose.rotation, helicopter.Pose.rotation, -Math.PI / 2);
helicopter.addComponent(G3DJToMesh(Models.helicopter));
helicopter.Mesh.shader = Shaders.skinned.program;
helicopter.addComponent(G3DJToSkeleton(Models.helicopter));
animation = G3DJToAnimation(Models.helicopter);
helicopter.addComponent(animation);

var cameraRotation = mat4.create();
var view = mat4.create();
var viewProjection = mat4.create();
var cameraLookAt = vec3.create();
var cameraUp = vec3.create();
var forward = vec3.fromValues(0, 0, -1);
var lightAngle = quat.create();
var lightDir = vec3.create();
var averageFPS = 0;
function loop(timestamp) {
    var delta = 0;
    if (prev_timestamp > 0) delta = (timestamp - prev_timestamp) / 1000;
    if(delta > 0)
        averageFPS = averageFPS * 0.2 + 1 / delta;
    $("#fps").text("FPS: " + averageFPS.toString().substr(0, 4));

    moveDir = vec3.create();
    if(keyboardState[87]) moveDir[2] -= 1;
    if(keyboardState[83]) moveDir[2] += 1;
    if(keyboardState[68]) moveDir[0] += 1;
    if(keyboardState[65]) moveDir[0] -= 1;
    if(keyboardState[32]) moveDir[1] += 1;
    if(keyboardState[67]) moveDir[1] -= 1;
    if(keyboardState[38]) phi -= cameraSensitivity * delta;
    if(keyboardState[40]) phi += cameraSensitivity * delta;
    if(keyboardState[37]) theta += cameraSensitivity * delta;
    if(keyboardState[39]) theta -= cameraSensitivity * delta;

    mat4.identity(cameraRotation);
    mat4.rotateY(cameraRotation, cameraRotation, theta);
    vec3.transformMat4(moveDir, moveDir, cameraRotation);
    cameraPosition = vec3.add(cameraPosition, cameraPosition, vec3.scale(moveDir, moveDir,moveSpeed * delta));
    theta -= mouseDiff.x * mouseSensitivity;
    phi -= mouseDiff.y * mouseSensitivity;
    if(theta > Math.PI * 2) theta -= Math.PI * 2;

    //Camera matrix calculation
    mat4.rotateX(cameraRotation, cameraRotation, phi);
    vec3.set(cameraLookAt, 0, 0, -1);
    vec3.set(cameraUp, 0, 1, 0);
    vec3.transformMat4(cameraLookAt, cameraLookAt, cameraRotation);
    vec3.transformMat4(cameraUp, cameraUp, cameraRotation);
    vec3.add(cameraLookAt, cameraLookAt, cameraPosition);
    mat4.lookAt(view, cameraPosition, cameraLookAt, cameraUp)

    //Light direction
    quat.rotateY(lightAngle, lightAngle, delta);
    vec3.transformQuat(lightDir, forward, lightAngle);

    dude.update(delta);
    helicopter.update(delta);
    renderManager.beginDraw(timestamp / 1000.0, lightDir, view, projection);
    dude.draw(renderManager);
    helicopter.draw(renderManager);
    prev_timestamp = timestamp;
    mouseDiff = {x: 0, y: 0};
    window.requestAnimationFrame(loop);
}
loop(0);
//]]> 

</script>

</html>


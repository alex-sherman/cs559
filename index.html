
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Herp Derp</title>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.3.1/gl-matrix-min.js"></script>
    <script src="class.js"></script>
    <script src="g3dj.js"></script>
    <script src="entity.js"></script>
    <script src="animation.js"></script>
    <script src="bone.js"></script>
    <script src="inputHandler.js"></script>
    <script src="primitive.js"></script>
    <script src="mesh.js"></script>
    <script src="renderManager.js"></script>
  
</head>
<body>
    <canvas id="canvas" style="position:absolute;"></canvas>
    <div id="containerDiv" align="center">
        <center>
            Use WASD to move the camera's location, and click into the <br>
            canvas or use the arrow keys to change the camera orientation.<br>
            Space and control move up and down.
        </center>
    </div>
  



<script type='text/javascript'>//<![CDATA[

var canvas = document.getElementById("canvas");
var ctx = canvas.getContext('2d');
var projection = mat4.create();
var renderManager = new RenderManager(ctx, canvas.width, canvas.height);
function resizeCallback() {
    canvas.width = document.documentElement.clientWidth - 10;
    canvas.height = document.documentElement.clientHeight - 10;
    renderManager.width = canvas.width;
    renderManager.height = canvas.height;
    projection = mat4.perspective(projection, Math.PI/2, canvas.width / canvas.height, 1, 100);
}
resizeCallback();
$(window).resize(function() {
    resizeCallback();
})
var mouseDiff = {x: 0, y: 0};
function moveCallback(x, y) {
    mouseDiff.x += x;
    mouseDiff.y += y;
}
initMouseHandling($("#canvas"), moveCallback);

var prev_timestamp = 0;
var cameraPosition = vec3.fromValues(1.3, 1.3, 0);
var theta = Math.PI / 2;
var phi = 0;
var moveSpeed = 10;
var cameraSensitivity = 1;
var moveDir = vec3.create();
var mouseSensitivity = 1 / 300;
var dude = new Entity();

$.ajax({
    url: "Models/male.g3dj",
    crossDomain: false,
    dataType: "json"
}).done(function(data) {
    var mesh = G3DJToMesh(data);
    dude.addComponent(mesh);
    var skeleton = G3DJToSkeleton(data);
    dude.addComponent(skeleton);
    $.ajax({
        url: "Models/anim.g3dj",
        crossDomain: false,
        dataType: "json"
    }).done(function(data) {
        var animation = G3DJToAnimation(data);
        dude.addComponent(animation);
    });
})
var cameraRotation = mat4.create();
var view = mat4.create();
var viewProjection = mat4.create();
var cameraLookAt = vec3.create();
var cameraUp = vec3.create();
var right = vec3.fromValues(1, 0, 0);
function loop(timestamp) {
    var delta = 0;
    if (prev_timestamp > 0) delta = (timestamp - prev_timestamp) / 1000;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    moveDir = vec3.create();
    if(keyboardState[87]) moveDir[2] -= 1;
    if(keyboardState[83]) moveDir[2] += 1;
    if(keyboardState[68]) moveDir[0] += 1;
    if(keyboardState[65]) moveDir[0] -= 1;
    if(keyboardState[32]) moveDir[1] += 1;
    if(keyboardState[17]) moveDir[1] -= 1;
    if(keyboardState[38]) phi -= cameraSensitivity * delta;
    if(keyboardState[40]) phi += cameraSensitivity * delta;
    if(keyboardState[37]) theta += cameraSensitivity * delta;
    if(keyboardState[39]) theta -= cameraSensitivity * delta;

    mat4.identity(cameraRotation);
    mat4.rotateY(cameraRotation, cameraRotation, theta);
    vec3.transformMat4(moveDir, moveDir, cameraRotation);
    cameraPosition = vec3.add(cameraPosition, cameraPosition, vec3.scale(moveDir, moveDir,moveSpeed * delta));
    theta -= mouseDiff.x * mouseSensitivity;
    phi -= mouseDiff.y * mouseSensitivity;
    if(theta > Math.PI * 2) theta -= Math.PI * 2;
    mat4.rotateX(cameraRotation, cameraRotation, phi);
    vec3.set(cameraLookAt, 0, 0, -1);
    vec3.set(right, 1, 0, 0);
    vec3.transformMat4(cameraLookAt, cameraLookAt, cameraRotation);
    vec3.transformMat4(right, right, cameraRotation);
    vec3.cross(cameraUp, right, cameraLookAt);
    vec3.add(cameraLookAt, cameraLookAt, cameraPosition);
    mat4.lookAt(view, cameraPosition, cameraLookAt, cameraUp)
    //mat4.identity(view);
    //mat4.rotateX(view, view, phi);
    //mat4.rotateY(view, view, theta);
    //vec3.scale(cameraPosition, cameraPosition, -1);
    //mat4.translate(view, view, cameraPosition);
    //var view = MatrixCreateView(Math.PI / 2,0, new Vector(-400,0,200));
    mat4.mul(viewProjection, projection, view);
    dude.update(delta);
    dude.draw(renderManager);
    renderManager.draw(viewProjection);
    prev_timestamp = timestamp;
    mouseDiff = {x: 0, y: 0};
    window.requestAnimationFrame(loop);
}
loop(0);
//]]> 

</script>

</html>


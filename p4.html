
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>3D Solid Walker</title>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="vector.js"></script>
    <script src="animation.js"></script>
    <script src="matrix.js"></script>
    <script src="bone.js"></script>
    <script src="inputHandler.js"></script>
    <script src="primitive.js"></script>
    <script src="mesh.js"></script>
    <script src="renderManager.js"></script>
  
</head>
<body>
    <div id="containerDiv" align="center">
        <center>
            Click into the canvas and use WASD to move the camera around<br>
            It is pretty subtle, but the animation is weighted/blended. <br>
            If you look at the knees you can tell that the edges of both the thighs and the calfs line up.<br>
            It also uses the painter's algorithm, but some rather bad Z-fighting occurs.<br>
            Because I don't have access to individial pixel's Z values, I rely on the average Z value of a triangle which gives rise to this problem.
        </center>
        <canvas id="canvas"></canvas>
    </div>
  



<script type='text/javascript'>//<![CDATA[

var canvas = document.getElementById("canvas");
canvas.width = 800;
canvas.height = 400;
var ctx = canvas.getContext('2d');
var renderManager = new RenderManager(ctx, canvas.width, canvas.height);

var skeleton = new Bone("chest", null);

new Bone("head", skeleton, MatrixCreateTranslation(0, -3, 0));
new Bone("leftThigh", skeleton, MatrixCreateTranslation(1, 2, 0));
new Bone("leftCalf", skeleton.bones["leftThigh"], MatrixCreateTranslation(1, 4, 0));
new Bone("rightThigh", skeleton, MatrixCreateTranslation(-1, 2, 0));
new Bone("rightCalf", skeleton.bones["rightThigh"], MatrixCreateTranslation(-1, 4, 0));

var mesh = new Mesh(skeleton);
var meshPart = Primitive.Cube(new Vector(-2, -2, -1.5), new Vector(2, 2, 1.5));
meshPart.bones = ["chest", "leftThigh", "rightThigh"];
meshPart.vertices[0].weights = [0.8, 0.2, 0];
meshPart.vertices[1].weights = [0.8, 0.2, 0];
meshPart.vertices[2].weights = [0.8, 0, 0.2];
meshPart.vertices[3].weights = [0.8, 0, 0.2];

meshPart.color = "red";
mesh.parts.push(meshPart);

["leftThigh", "leftCalf", "rightThigh", "rightCalf"].map(function(bone, i, bones) {
    var offset = new Vector(0, -3, 0);
    if(i < 2) offset.x -= 1;
    else offset.x += 1;
    if(i % 2) offset.y -= 2;
    meshPart = Primitive.Cube(new Vector(-1,-1,-1).add(offset), new Vector(1,1,1).add(offset));
    meshPart.bones = i % 2 ? [bone, bones[i - 1], bone] : [bone, "chest", bones[i + 1]];
    meshPart.color = i % 2 ? "green" : "blue";
    //if(i % 2) {
        meshPart.vertices.map(function(vertex, j, vertices) {
            if(j > 3)
                vertex.weights = [0.2, 0.8, 0];
            else
                vertex.weights = [0.8, 0, 0.2];
        })
    //}
    mesh.parts.push(meshPart);
});

meshPart = Primitive.Cube(new Vector(-1,2,-1), new Vector(1,4,1));
meshPart.bones = ["head"];
meshPart.color = "orange"
mesh.parts.push(meshPart);

anim = new Animation(skeleton);
anim.addKeyFrame(0, "chest", MatrixCreateTranslation(0, 0, 0));
anim.addKeyFrame(0, "head", MatrixCreateTranslation(0, 3, 0));
function insertLegFrames(t) {
    anim.addKeyFrame(t + 0, "leftThigh", MatrixCreateTranslation(-1, -2, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/4,0)));
    anim.addKeyFrame(t + 0, "rightThigh", MatrixCreateTranslation(1, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/4,0)));
    anim.addKeyFrame(t + 0, "leftCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 0, "rightCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/8,0)));

    anim.addKeyFrame(t + 1, "leftThigh", MatrixCreateTranslation(-1, -2, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/8,0)));
    anim.addKeyFrame(t + 1, "rightThigh", MatrixCreateTranslation(1, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/8,0)));

    anim.addKeyFrame(t + 2, "leftThigh", MatrixCreateTranslation(-1, -2, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 2, "leftCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 2, "rightThigh", MatrixCreateTranslation(1, -2, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 2, "rightCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/2,0)));

    anim.addKeyFrame(t + 3, "leftThigh", MatrixCreateTranslation(-1, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/8,0)));
    anim.addKeyFrame(t + 3, "rightThigh", MatrixCreateTranslation(1, -2, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/8,0)));
    anim.addKeyFrame(t + 3, "rightCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/4,0)));

    anim.addKeyFrame(t + 4, "leftThigh", MatrixCreateTranslation(-1, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/4,0)));
    anim.addKeyFrame(t + 4, "leftCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0, Math.PI/8,0)));
    anim.addKeyFrame(t + 4, "rightThigh", MatrixCreateTranslation(1, -2, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/4,0)));
    anim.addKeyFrame(t + 4, "rightCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0,0,0)));

    anim.addKeyFrame(t + 5, "rightThigh", MatrixCreateTranslation(1, -2, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/8,0)));
    anim.addKeyFrame(t + 5, "leftThigh", MatrixCreateTranslation(-1, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/8,0)));

    anim.addKeyFrame(t + 6, "rightThigh", MatrixCreateTranslation(1, -2, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 6, "rightCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 6, "leftThigh", MatrixCreateTranslation(-1, -2, 0).mul(MatrixCreateRotationYPR(0,0,0)));
    anim.addKeyFrame(t + 6, "leftCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/2,0)));

    anim.addKeyFrame(t + 7, "rightThigh", MatrixCreateTranslation(1, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/8,0)));
    anim.addKeyFrame(t + 7, "leftThigh", MatrixCreateTranslation(-1, -2, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/8,0)));
    anim.addKeyFrame(t + 7, "leftCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/4,0)));

    anim.addKeyFrame(t + 8, "rightThigh", MatrixCreateTranslation(1, -2, 0).mul(MatrixCreateRotationYPR(0,Math.PI/4,0)));
    anim.addKeyFrame(t + 8, "rightCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0, Math.PI/8,0)));
    anim.addKeyFrame(t + 8, "leftThigh", MatrixCreateTranslation(-1, -2, 0).mul(MatrixCreateRotationYPR(0,-Math.PI/4,0)));
    anim.addKeyFrame(t + 8, "leftCalf", MatrixCreateTranslation(0, -2, 0).mul(MatrixCreateRotationYPR(0,0,0)));
}
insertLegFrames(0);
insertLegFrames(8);
insertLegFrames(16);
insertLegFrames(24);

var mouseDiff = {x: 0, y: 0};
function moveCallback(x, y) {
    mouseDiff.x += x;
    mouseDiff.y += y;
}
initMouseHandling($("#canvas"), moveCallback);
ctx.clearRect(0, 0, canvas.width, canvas.height);

var prev_timestamp = 0;
var projection = MatrixCreateProjection(Math.PI/2, 2, 1, 20);
var cameraPosition = new Vector(10, 0, 10);
var theta = -3 * Math.PI/4;
var phi = 0;
var moveSpeed = 0.1;
var moveDir = new Vector();
var mouseSensitivity = 1 / 100;
ctx.setTransform(1, 0, 0, -1, canvas.width / 2, canvas.height / 2);
function loop(timestamp) {
    var delta = 0;
    if (prev_timestamp > 0) delta = timestamp - prev_timestamp;
    ctx.clearRect(-canvas.width / 2, -canvas.height/2, canvas.width, canvas.height);

    moveDir = new Vector();
    if(keyboardState[87]) moveDir.z += 1;
    if(keyboardState[83]) moveDir.z -= 1;
    if(keyboardState[68]) moveDir.x += 1;
    if(keyboardState[65]) moveDir.x -= 1;
    moveDir = MatrixCreateRotationYPR(theta, 0, 0).transform(moveDir);
    cameraPosition = cameraPosition.add(moveDir.mul(moveSpeed));

    theta += mouseDiff.x * mouseSensitivity;
    phi += mouseDiff.y * mouseSensitivity;
    if(theta > Math.PI * 2) theta -= Math.PI * 2;
    var view = MatrixCreateView(theta, phi, cameraPosition);
    //var view = MatrixCreateView(Math.PI / 2,0, new Vector(-400,0,200));
    var viewProjection = projection.mul(view);
    anim.update(delta/150);
    mesh.draw(renderManager);
    renderManager.draw(viewProjection);
    prev_timestamp = timestamp;
    mouseDiff = {x: 0, y: 0};
    window.requestAnimationFrame(loop);
}
loop(0);
//]]> 

</script>

</html>

